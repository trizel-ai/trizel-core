name: Deprecated Terms Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-deprecated-terms:
    runs-on: ubuntu-latest
    name: "Deprecated Terms Check / Check for deprecated terminology"
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan YAML/JSON for deprecated terms
        shell: bash
        run: |
          set -euo pipefail
          export LC_ALL=C

          echo "Scanning YAML/JSON only for deprecated terms..."

          # Exclude common directories to reduce noise and runtime.
          EXCLUDES=(
            "--exclude-dir=.git"
            "--exclude-dir=.github"
            "--exclude-dir=governance"
            "--exclude-dir=node_modules"
            "--exclude-dir=vendor"
            "--exclude-dir=dist"
            "--exclude-dir=build"
            "--exclude-dir=target"
            "--exclude-dir=.venv"
            "--exclude-dir=.mypy_cache"
            "--exclude-dir=.pytest_cache"
          )

          # Limit scan scope to YAML/JSON only.
          INCLUDES=(
            "--include=*.yml"
            "--include=*.yaml"
            "--include=*.json"
          )

          fail_if_found() {
            local label="$1"
            local pattern="$2"
            local message="$3"

            echo ""
            echo "==> ${label}"
            # -I ignores binary files; -E enables extended regex; -n prints line numbers; -r recursive.
            if grep -rIEn "${EXCLUDES[@]}" "${INCLUDES[@]}" "${pattern}" . ; then
              echo ""
              echo "❌ ERROR: ${message}"
              exit 1
            fi
            echo "✓ OK: ${label}"
          }

          # 1) STOE (word-boundary)
          fail_if_found \
            "Check for deprecated term 'STOE'" \
            "\bSTOE\b" \
            "Found deprecated term 'STOE' in YAML/JSON payloads. Remove it completely."

          # 2) V12–V22 (word-boundary)
          fail_if_found \
            "Check for deprecated version labels V12–V22" \
            "\bV(12|13|14|15|16|17|18|19|20|21|22)\b" \
            "Found deprecated version labels (V12–V22) in YAML/JSON payloads. Remove them completely."

          # 3) V<number> system (case-insensitive)
          fail_if_found \
            "Check for forbidden 'V<number> system' patterns" \
            "\bV[0-9]+[[:space:]]+system\b" \
            "Found forbidden 'V<number> system' patterns in YAML/JSON payloads. Remove them completely."

          # 4) Algorithm name variants (case-sensitive per policy)
          # Allowed canonical only: "AUTO DZ ACT"
          fail_if_found \
            "Verify algorithm name format (variants forbidden)" \
            "AUTO-DZ-ACT|AutoDzAct|auto dz act|AUTO DZ ACT[[:space:]]+system|AUTO DZ ACT[[:space:]]+v" \
            "Found incorrect algorithm name variant in YAML/JSON payloads. Allowed: AUTO DZ ACT (exact)."

          echo ""
          echo "✓ All deprecated terms checks PASSED (YAML/JSON scope)"
          echo "✓ No forbidden terminology detected in YAML/JSON payloads"
          echo "✓ Repository compliant with TRIZEL DIRECTIVE"