name: Deprecated Terms Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master, develop]

permissions:
  contents: read

jobs:
  check-deprecated-terms:
    runs-on: ubuntu-latest
    name: Check for deprecated terminology (YAML/JSON only)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for STOE (YAML/JSON only)
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for deprecated term 'STOE' in YAML/JSON files only..."

          if grep -rEn "STOE" \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --include="*.yml" \
            --include="*.yaml" \
            --include="*.json" \
            . ; then
            echo "❌ ERROR: Found deprecated term 'STOE' in YAML/JSON metadata/config."
            echo "STOE is permanently forbidden inside YAML/JSON payloads."
            exit 1
          fi

          echo "✓ No instances of 'STOE' found in YAML/JSON files"

      - name: Check for V12-V22 version labels (YAML/JSON only)
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for deprecated version labels (V12-V22) in YAML/JSON files only..."

          if grep -rEn "\bV(12|13|14|15|16|17|18|19|20|21|22)\b" \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --include="*.yml" \
            --include="*.yaml" \
            --include="*.json" \
            . ; then
            echo "❌ ERROR: Found deprecated version labels (V12-V22) in YAML/JSON payloads."
            echo "These version labels are permanently forbidden."
            exit 1
          fi

          echo "✓ No deprecated V12-V22 labels found in YAML/JSON files"

      - name: Check for versioned system labels (YAML/JSON only)
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for forbidden 'V<number> system' patterns in YAML/JSON files only..."

          if grep -rEin "\bV[0-9]+ system\b" \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --include="*.yml" \
            --include="*.yaml" \
            --include="*.json" \
            . ; then
            echo "❌ ERROR: Found versioned system labels in YAML/JSON payloads."
            echo "Versioned system labels are forbidden. Remove them completely."
            exit 1
          fi

          echo "✓ No versioned system labels found in YAML/JSON files"

      - name: Verify algorithm name format (YAML/JSON only)
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for incorrect algorithm name variants in YAML/JSON files only..."

          # Forbidden variants (case-sensitive). Allowed canonical string only: "AUTO DZ ACT"
          if grep -rEn "AUTO-DZ-ACT|AutoDzAct|auto dz act|AUTO DZ ACT system|AUTO DZ ACT v" \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --include="*.yml" \
            --include="*.yaml" \
            --include="*.json" \
            . ; then
            echo "❌ ERROR: Found incorrect algorithm name variant in YAML/JSON payloads."
            echo "Allowed canonical algorithm name: AUTO DZ ACT"
            echo "No variants, no 'system' suffix, no version numbers."
            exit 1
          fi

          echo "✓ Algorithm name format check passed for YAML/JSON files"

      - name: Summary
        if: success()
        shell: bash
        run: |
          set -euo pipefail
          echo ""
          echo "✓ All deprecated terms checks PASSED (YAML/JSON scope)"
          echo "✓ No forbidden terminology detected in YAML/JSON payloads"
          echo "✓ Repository compliant with TRIZEL DIRECTIVE"
