name: Governance Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master, develop]

permissions:
  contents: read

jobs:
  validate-governance:
    runs-on: ubuntu-latest
    name: Validate governance boundaries

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Layer 0 boundaries (no executable code)
        run: |
          set -euo pipefail
          echo "Validating Layer 0 (Governance) boundaries..."

          echo "Checking for executable code files..."
          # Notes:
          # - Explicitly exclude .git and .github and common docs-only assets.
          # - Keep list conservative; expand only by governance decision.
          if find . -type f \
            \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.cpp" -o -name "*.c" -o -name "*.h" -o -name "*.go" -o -name "*.rs" -o -name "*.rb" -o -name "*.php" -o -name "*.sh" -o -name "*.ps1" -o -name "*.bat" \) \
            -not -path "./.git/*" \
            -not -path "./.github/*" \
            | grep -q . ; then
            echo "❌ ERROR: Found executable code files. Layer 0 must not contain executable code."
            find . -type f \
              \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.cpp" -o -name "*.c" -o -name "*.h" -o -name "*.go" -o -name "*.rs" -o -name "*.rb" -o -name "*.php" -o -name "*.sh" -o -name "*.ps1" -o -name "*.bat" \) \
              -not -path "./.git/*" \
              -not -path "./.github/*"
            exit 1
          fi
          echo "✓ No executable code files found"

      # IMPORTANT: Layer 0 may legitimately contain YAML/JSON as governance schema/templates.
      # Therefore we only block "data-like" formats that are rarely governance, and we
      # ALLOW YAML/JSON by default.
      - name: Verify Layer 0 boundaries (no datasets / databases / notebooks)
        run: |
          set -euo pipefail
          echo "Checking for prohibited dataset / database / notebook artifacts..."

          prohibited_patterns=(
            "*.csv"
            "*.parquet"
            "*.feather"
            "*.arrow"
            "*.db"
            "*.sqlite"
            "*.sqlite3"
            "*.pkl"
            "*.pickle"
            "*.h5"
            "*.hdf5"
            "*.sav"
            "*.dta"
            "*.mat"
            "*.ipynb"
          )

          found_any=false
          for pat in "${prohibited_patterns[@]}"; do
            if find . -type f -name "$pat" \
              -not -path "./.git/*" \
              -not -path "./.github/*" \
              | grep -q . ; then
              echo "❌ ERROR: Found prohibited artifact type: $pat"
              find . -type f -name "$pat" \
                -not -path "./.git/*" \
                -not -path "./.github/*"
              found_any=true
            fi
          done

          if [ "$found_any" = true ]; then
            echo "Layer 0 must not contain datasets, databases, or analysis notebooks."
            exit 1
          fi
          echo "✓ No datasets/databases/notebooks found"

      - name: Verify required governance files exist (root)
        run: |
          set -euo pipefail
          echo "Checking for required governance files..."

          # Keep aligned with ROLE.md exports / repo charter.
          required_files=(
            "COPILOT_INSTRUCTIONS.md"
            "ROLE.md"
            "OUTPUT_CONTRACT.md"
            "PUBLICATION_POLICY.md"
            "DEPRECATED_TERMS.md"
            "README.md"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "❌ ERROR: Missing required governance files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi
          echo "✓ All required governance files present"

      - name: Validate markdown files are non-empty
        run: |
          set -euo pipefail
          echo "Validating markdown files (non-empty)..."

          while IFS= read -r -d '' file; do
            if [ ! -s "$file" ]; then
              echo "❌ ERROR: Empty markdown file: $file"
              exit 1
            fi
          done < <(find . -type f -name "*.md" -not -path "./.git/*" -print0)

          echo "✓ All markdown files validated"

      # This is a WARNING-only heuristic scan. It must never block merges by itself.
      # Also exclude internal policy packs where examples may appear as illustrative text.
      - name: Heuristic scan for cross-layer content indicators (warning-only)
        run: |
          set -euo pipefail
          echo "Heuristic scan for cross-layer indicators (warning-only)..."

          forbidden_phrases=(
            "def main"
            "if __name__"
            "import pandas"
            "import numpy"
            "SELECT * FROM"
            "statistical test"
            "model training"
          )

          violations_found=false
          for phrase in "${forbidden_phrases[@]}"; do
            if grep -rin "$phrase" \
              --exclude-dir=.git \
              --exclude-dir=.github \
              --exclude="governance-validation.yml" \
              --exclude-dir="docs/internal/policy" \
              --include="*.md" \
              . ; then
              echo "⚠ WARNING: Found potential cross-layer indicator: '$phrase'"
              violations_found=true
            fi
          done

          if [ "$violations_found" = true ]; then
            echo "⚠ REVIEW REQUIRED: Potential cross-layer indicators detected in markdown."
            echo "This job does not fail on heuristics; validate context manually."
          else
            echo "✓ No cross-layer indicators detected (heuristic)"
          fi

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "✓ Governance validation checks PASSED"
          echo "✓ Layer 0 boundaries enforced (no executable code / datasets / notebooks)"
          echo "✓ Required governance files present"
          echo "✓ Markdown non-empty validation passed"
