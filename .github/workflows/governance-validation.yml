name: Governance Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-governance:
    runs-on: ubuntu-latest
    name: "Governance Validation / Validate governance boundaries"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Layer 0 boundaries (no executable code)
        run: |
          set -euo pipefail
          echo "Validating Layer 0 (Governance) boundaries..."

          echo "Checking for executable code files..."
          # Notes:
          # - Explicitly exclude .git, .github, and scripts/governance (governance automation scripts allowed).
          # - Keep list conservative; expand only by governance decision.
          if find . -type f \
            \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.cpp" -o -name "*.c" -o -name "*.h" -o -name "*.go" -o -name "*.rs" -o -name "*.rb" -o -name "*.php" -o -name "*.swift" -o -name "*.cs" -o -name "*.kt" -o -name "*.m" -o -name "*.mm" -o -name "*.scala" \) \
            -not -path "./.git/*" \
            -not -path "./.github/*" \
            -not -path "./scripts/governance/*" \
            | grep -q . ; then
            echo "❌ ERROR: Found executable code files. Layer 0 must not contain executable code."
            find . -type f \
              \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.java" -o -name "*.cpp" -o -name "*.c" -o -name "*.h" -o -name "*.go" -o -name "*.rs" -o -name "*.rb" -o -name "*.php" -o -name "*.swift" -o -name "*.cs" -o -name "*.kt" -o -name "*.m" -o -name "*.mm" -o -name "*.scala" \) \
              -not -path "./.git/*" \
              -not -path "./.github/*" \
              -not -path "./scripts/governance/*"
            exit 1
          fi
          echo "✓ No executable code files found"

      # IMPORTANT: Layer 0 may legitimately contain YAML/JSON as governance schema/templates.
      # Therefore we only block "data-like" formats that are rarely governance, and we
      # ALLOW YAML/JSON by default.
      - name: Verify Layer 0 boundaries (no datasets / databases / notebooks)
        run: |
          set -euo pipefail
          echo "Checking for prohibited dataset / database / notebook artifacts..."

          prohibited_patterns=(
            "*.csv"
            "*.parquet"
            "*.feather"
            "*.arrow"
            "*.db"
            "*.sqlite"
            "*.sqlite3"
            "*.pkl"
            "*.pickle"
            "*.h5"
            "*.hdf5"
            "*.sav"
            "*.dta"
            "*.mat"
            "*.ipynb"
          )

          found_any=false
          for pat in "${prohibited_patterns[@]}"; do
            if find . -type f -name "$pat" \
              -not -path "./.git/*" \
              -not -path "./.github/*" \
              | grep -q . ; then
              echo "❌ ERROR: Found prohibited artifact type: $pat"
              find . -type f -name "$pat" \
                -not -path "./.git/*" \
                -not -path "./.github/*"
              found_any=true
            fi
          done

          if [ "$found_any" = true ]; then
            echo "Layer 0 must not contain datasets, databases, or analysis notebooks."
            exit 1
          fi
          echo "✓ No datasets/databases/notebooks found"

      - name: Verify required governance files exist (root)
        run: |
          set -euo pipefail
          echo "Checking for required governance files..."

          # Keep aligned with ROLE.md exports / repo charter.
          required_files=(
            "COPILOT_INSTRUCTIONS.md"
            "ROLE.md"
            "OUTPUT_CONTRACT.md"
            "PUBLICATION_POLICY.md"
            "DEPRECATED_TERMS.md"
            "README.md"
          )

          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done

          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "❌ ERROR: Missing required governance files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi
          echo "✓ All required governance files present"

      - name: Validate markdown files are non-empty
        run: |
          set -euo pipefail
          echo "Validating markdown files (non-empty)..."

          while IFS= read -r -d '' file; do
            if [ ! -s "$file" ]; then
              echo "❌ ERROR: Empty markdown file: $file"
              empty_found=true
            fi
          done < <(find . -type f -name "*.md" -not -path "./.git/*" -print0)

          echo "✓ All markdown files validated"

      # This is a WARNING-only heuristic scan. It must never block merges by itself.
      # Also exclude internal policy packs where examples may appear as illustrative text.
      - name: Heuristic scan for cross-layer content indicators (warning-only)
        run: |
          set -euo pipefail
          echo "Heuristic scan for cross-layer indicators (warning-only)..."

          forbidden_phrases=(
            "def main"
            "if __name__"
            "import pandas"
            "import numpy"
            "SELECT * FROM"
            "data analysis"
            "statistical test"
            "model training"
          )

          violations_found=false
          for phrase in "${forbidden_phrases[@]}"; do
            if grep -rin --include="*.md" --exclude="governance-validation.yml" \
              --exclude-dir=.git --exclude-dir=.github \
              --exclude-dir=node_modules --exclude-dir=vendor --exclude-dir=dist --exclude-dir=build --exclude-dir=target \
              --exclude-dir=.venv --exclude-dir=.mypy_cache --exclude-dir=.pytest_cache \
              "$phrase" . ; then
              echo "⚠️ WARNING: Found potentially cross-layer phrase: '$phrase'"
              violations_found=true
            fi
          done

          if [ "$violations_found" = true ]; then
            echo "⚠️ Review required: Potential cross-layer content detected (warning-only)."
          else
            echo "✓ No cross-layer phrases detected"
          fi

          echo ""
          echo "✓ All governance validation checks PASSED"
          echo "✓ Repository maintains Layer 0 boundaries"
          echo "✓ No executable code, data files, or notebooks detected"
          echo "✓ Required governance files present"
